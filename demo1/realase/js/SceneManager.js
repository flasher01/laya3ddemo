var SceneManager=function(){function e(){this._renderQueenNu=5e3,this.characterArr=new Array,this.fightCharacterEnemyArr=new Array,this.fightCharacterPlayerArr=new Array,this.bInFight=!1,this.roleID=[6105,6111,6600,6609,6610,6635,6690,6697,6701,6709,6714,6724,8204,"longnv"],this._initLayer(),this._initCamera2d()}return Object.defineProperty(e,"instance",{get:function(){return this._ins||(this._ins=new e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"characterFightLayer3D",{get:function(){return this._characterFightLayer3D},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"camera2D",{get:function(){return this._curCamera2D},enumerable:!0,configurable:!0}),e.prototype.enterFight=function(){this.bInFight=!0;for(var e=0,a=this.characterArr;e<a.length;e++){var t=a[e].getComponentByType(AIMoveScript);t.enable=!1,t.stopFindPath()}if(this._sceneFight.visible=!0,this.fightBg.visible=!0,this._initFightScene3D(),0==this.fightCharacterEnemyArr.length){for(var r=FightCoordinatePos.pos_enemy3D.length,i=(new Laya.Point,this.roleID.length,void 0),n=void 0,h=void 0,o=0,c=0;c<r;c++)n=Math.floor(Math.random()*this.roleID.length),i=this.roleID[n],o++,(h=this._addFightCharacher(i,new Laya.Vector3(FightCoordinatePos.pos_enemy3D[c][0],FightCoordinatePos.pos_enemy3D[c][1],FightCoordinatePos.pos_enemy3D[c][2]))).turnTo(45),h.camp=CampType.Enemy,h.fightPoint=c,this.fightCharacterEnemyArr.push(h),this._characterFightLayer3D.addChild(h.roleSp3D);r=FightCoordinatePos.pos_player3D.length;for(c=0;c<r;c++)n=Math.floor(Math.random()*this.roleID.length),i=this.roleID[n],o++,(h=7==c?this._addFightMainCharacher("zhujue","6044","6437","6578",new Laya.Vector3(FightCoordinatePos.pos_player3D[c][0],FightCoordinatePos.pos_player3D[c][1],FightCoordinatePos.pos_player3D[c][2])):this._addFightCharacher(i,new Laya.Vector3(FightCoordinatePos.pos_player3D[c][0],FightCoordinatePos.pos_player3D[c][1],FightCoordinatePos.pos_player3D[c][2]))).camp=CampType.Player,h.fightPoint=c,h.turnTo(-135),this.fightCharacterPlayerArr.push(h),this._characterFightLayer3D.addChild(h.roleSp3D)}this._sceneFight.addChild(this.curCamera3D),AIFightControl.instance.startup()},e.prototype.exitFight=function(){this.fightBg.visible=!1,this._sceneFight.visible=!1;for(var e=0,a=this.characterArr;e<a.length;e++){var t=(n=a[e]).getComponentByType(AIMoveScript);t.enable=!0,t.resumeFindPath()}this._sceneHangUp.addChild(this.curCamera3D);for(var r=0,i=this.fightCharacterEnemyArr;r<i.length;r++){var n=i[r];n.clearSelf(),n=null}this.fightCharacterEnemyArr=[];for(var h=0,o=this.fightCharacterPlayerArr;h<o.length;h++){var c=o[h];c.clearSelf(),c=null}this.fightCharacterPlayerArr=[],this.bInFight=!1},e.prototype.orthographicCoordToScreenCoord=function(e,a){this.curCamera3D.viewport.project(e,this.curCamera3D.projectionViewMatrix,a),a.x=a.x/Laya.stage.clientScaleX,a.y=a.y/Laya.stage.clientScaleY},e.prototype.convertScreenCoordToOrthographicCoord=function(e,a){this.curCamera3D.convertScreenCoordToOrthographicCoord(e,a)},e.prototype.addMainCharacterAIControl=function(){var a,t=new Laya.Vector3,r=new Laya.Point,i=250+(e.instance.bgLayer.width-450)*Math.random(),n=350+(e.instance.bgLayer.height-750)*Math.random();r.setTo(i,n),r=e.instance.bgLayer.localToGlobal(r),e.instance.convertScreenCoordToOrthographicCoord(new Laya.Vector3(r.x,r.y),t);var h=new Character(t);return h.createCharacter("zhujue","6044","6437","6578"),h.name="zhujue",e.instance.characterLayer3D.addChild(h.roleSp3D),(a=new Laya.Sprite).pos(r.x,r.y),a.name="zhujue",e.instance.bgLayer.addChild(a),h.addComponent(AIMoveScript),h.pAIMoveScript=h.getComponentByType(AIMoveScript),this.characterArr.push(h),h.data=new CharacterModel,h.agentSprite2D=a,this.camera2D.focusTarget=h.agentSprite2D,h},e.prototype.addMainCharacterClickStage=function(a,t){var r=new Character;return r.createCharacter("zhujue","60441","6437",null),e.instance.characterLayer3D.addChild(r.roleSp3D),r.on(Character.LOAD_COMPLETE,a,t),r},e.prototype.addCharacter=function(a,t,r){var i,n=new Laya.Vector3,h=new Laya.Point;h=e.instance.bgLayer.localToGlobal(r),e.instance.convertScreenCoordToOrthographicCoord(new Laya.Vector3(h.x,h.y),n);var o=new Character(n);return o.addComponent(AIMoveScript),o.pAIMoveScript=o.getComponentByType(AIMoveScript),(i=new Laya.Sprite).pos(r.x,r.y),i.name=t+"",e.instance.bgLayer.addChild(i),o.data=new CharacterModel,o.name=a+"",o.agentSprite2D=i,e.instance.characterLayer3D.addChild(o.roleSp3D),o.createCharacter(a,null,null,null),this.characterArr.push(o),o},e.prototype.initScene3D=function(){this._sceneHangUp=new Laya.Scene,Laya.stage.addChild(this._sceneHangUp),this.curCamera3D=new Laya.Camera(0,.1,300),this._sceneHangUp.addChild(this.curCamera3D),this.characterLayer3D=new Laya.Sprite3D,this._sceneHangUp.addChild(this.characterLayer3D),this._sceneHangUp.mouseEnabled=!1,this._sceneHangUp.mouseThrough=!0,this.curCamera3D.transform.translate(new Laya.Vector3(0,0,150)),this.curCamera3D.clearColor=null,this.curCamera3D.orthographic=!0,this.curCamera3D.orthographicVerticalSize=30,this.curCamera3D.clearFlag=Laya.BaseCamera.CLEARFLAG_DEPTHONLY,this.curCamera3D.viewport=new Laya.Viewport(GameModel.viewportX,GameModel.viewportY,GameModel.viewportW*Laya.stage.clientScaleX,GameModel.viewportH*Laya.stage.clientScaleY),Laya.stage.on(Laya.Event.RESIZE,this,this._resetCamera3DViewPort);var a=new Laya.Vector3(30*Math.PI/180);this.characterLayer3D.transform.rotationEuler=a,this._sceneHangUp.addChild(e.instance.characterLayer3D),this._initFightScene3D()},e.prototype.initScene2D=function(a){e.instance.bgLayer.addChild(a),e.instance.bgLayer.width=a.getBounds().width,e.instance.bgLayer.height=a.getBounds().height,e.instance.camera2D.setBoundary(e.instance.bgLayer),e.instance.camera2D.start();var t=new Laya.Label("2D场景3D角色演示");t.fontSize=30,t.color="#ffffff",t.strokeColor="#000000",t.bold=!0,t.x=Laya.stage.designWidth-t.width>>1,t.y=5,Laya.stage.addChild(t),Laya.timer.frameLoop(1,this,this._update)},e.prototype._resetCamera3DViewPort=function(){this.curCamera3D.viewport=new Laya.Viewport(GameModel.viewportX,GameModel.viewportY,GameModel.viewportW*Laya.stage.clientScaleX,GameModel.viewportH*Laya.stage.clientScaleY),LoaderManager.instance.resetTxtPos()},e.prototype._initLayer=function(){this._stageContainer=new Laya.Sprite,Laya.stage.addChild(this._stageContainer),this.bgLayer=new Laya.Sprite,this.bgLayer.name="background",this._stageContainer.addChild(this.bgLayer),this.characterLayer2D=new Laya.Sprite,this._stageContainer.addChild(this.characterLayer2D),this.fightBg=new Laya.Sprite,this.fightBg.graphics.drawRect(0,0,Laya.stage.designWidth,Laya.stage.designHeight,"#000000"),this.fightBg.alpha=.5,Laya.stage.addChild(this.fightBg),this.fightBg.visible=!1,this.progressLayer=new Laya.Sprite,this.progressLayer.mouseEnabled=!1,Laya.stage.addChild(this.progressLayer),this._initFightScene3D();new Laya.Vector3(30*Math.PI/180);this.effectLayer2D=new Laya.Sprite,Laya.stage.addChild(this.effectLayer2D)},e.prototype._initCamera2d=function(){var e=[{name:"background",instance:this.bgLayer,ratio:.2}];this._curCamera2D=new Camera2D(Laya.stage,this._stageContainer,new Laya.Point(.5*Laya.stage.designWidth,.5*Laya.stage.designHeight),e)},e.prototype._update=function(){e.instance.camera2D.update()},e.prototype._initFightScene3D=function(){if(!this._sceneFight){this._sceneFight=new Laya.Scene,Laya.stage.addChild(this._sceneFight),this._characterFightLayer3D=new Laya.Sprite3D;var e=new Laya.Vector3(30*Math.PI/180);this._characterFightLayer3D.transform.rotationEuler=e,this._sceneFight.addChild(this._characterFightLayer3D)}},e.prototype._addFightCharacher=function(e,a,t){var r=new Character(a,t);return r.createCharacter(e,null,null,null),r.name=e+"",r.data=new CharacterModel,r.pAIFightScript=r.addComponent(AIFightScript),r},e.prototype._addFightMainCharacher=function(e,a,t,r,i,n){var h=new Character(i,n);return h.createCharacter(e,a,t,r),h.name=e+"",h.data=new CharacterModel,h.pAIFightScript=h.addComponent(AIFightScript),h},e}();